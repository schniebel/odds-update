apiVersion: platform.example.org/v1alpha1
kind: ClusterPipelineClaim
metadata:
  name: odds-compute-eks-prod
  namespace: crossplane-system
spec:
  parameters:
    region: us-east-1
    clusterName: odds-compute-eks-prod
    version: "1.31"
    subnetIds: ["odds-update-vpc-prod","...etc"]
    controlPlaneRoleArn: arn:aws:iam::<iam-account-here>:role/EKSControlPlaneRole
    nodeRoleArn: arn:aws:iam::<iam-account-here>:role/EKSNodeRole
    desiredSize: 3
    minSize: 3
    maxSize: 6
    instanceTypes: ["m6i.xlarge"]
    script: |
      echo "Creating cluster connection credentials..."

      aws eks update-kubeconfig \
        --name analytics-eks \
        --region $AWS_REGION \
        --profile $AWS_PROFILE

      SECRET_NAME="analytics-eks-prod-kubeconfig"

      kubectl apply -n flux-system -f - <<EOF
      apiVersion: v1
      kind: Secret
      metadata:
        name: $SECRET_NAME
        namespace: flux-system
      type: Opaque
      stringData:
        value: |-
      $(printf '%s\n' "$KUBECONFIG_CONTENT" | sed 's/^/    /')
      EOF
